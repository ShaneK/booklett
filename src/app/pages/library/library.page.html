<ion-header [translucent]="true" class="dark:!bg-transparent">
  <ion-toolbar class="bg-surface/80 backdrop-blur">
    <ion-select
      slot="start"
      interface="popover"
      [value]="libraryType$ | async"
      (ionChange)="setLibraryType($event.detail.value)"
      class="font-semibold ml-2 min-w-[120px] max-w-[150px]">
      <ion-select-option value="authors">
        <ion-icon name="people-outline" class="mr-2"></ion-icon>
        Authors
      </ion-select-option>
      <ion-select-option value="books">
        <ion-icon name="book-outline" class="mr-2"></ion-icon>
        Books
      </ion-select-option>
    </ion-select>
    <ion-buttons slot="end">
      <ion-button (click)="setView('list')" [class.opacity-100]="(view$ | async) === 'list'" [class.opacity-50]="(view$ | async) !== 'list'">
        <ion-icon slot="icon-only" name="list-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="setView('grid')" [class.opacity-100]="(view$ | async) === 'grid'" [class.opacity-50]="(view$ | async) !== 'grid'">
        <ion-icon slot="icon-only" name="grid-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <!-- Segment toolbar for books library type -->
  <ion-toolbar class="bg-surface" *ngIf="(libraryType$ | async) === 'books'">
    <ion-segment
      class="w-full mx-3 mb-1"
      [value]="bookMediaType$ | async"
      (ionChange)="setBookMediaType($any($event.detail.value))">
      <ion-segment-button value="audiobook">
        <ion-label>Audiobooks</ion-label>
      </ion-segment-button>
      <ion-segment-button value="ebook">
        <ion-label>eBooks</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
  <ion-toolbar class="bg-surface">
    <ion-searchbar
      [placeholder]="(libraryType$ | async) === 'authors' ? 'Search authors' : 'Search books'"
      (ionInput)="onSearch($event)"></ion-searchbar>
    <div class="flex items-center gap-2 px-4 pb-2">
      <ion-chip (click)="presentSortOptions()" class="bg-card">
        <ion-icon name="filter-outline" class="text-muted"></ion-icon>
        <ion-label class="text-sm">{{ getSortLabel() }}</ion-label>
      </ion-chip>
      <ion-chip (click)="toggleOrder()" class="bg-card">
        <ion-icon [name]="(order$ | async) === 'asc' ? 'arrow-up-outline' : 'arrow-down-outline'" class="text-muted"></ion-icon>
        <ion-label class="text-sm">{{ (order$ | async) === 'asc' ? 'A-Z' : 'Z-A' }}</ion-label>
      </ion-chip>
      <div class="ml-auto text-xs text-muted">
        <ng-container *ngIf="(libraryType$ | async) === 'authors'">
          {{ getDisplayedCount() }} / {{ getTotalCount() }} authors
        </ng-container>
        <ng-container *ngIf="(libraryType$ | async) === 'books'">
          {{ getDisplayedCount() }} / {{ getTotalCount() }} {{ (bookMediaType$ | async) === 'audiobook' ? 'audiobooks' : 'ebooks' }}
        </ng-container>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="bg-bg">
  <!-- Server not configured message -->
  <div *ngIf="!hasValidBaseUrl()" class="flex flex-col items-center justify-center h-full p-4 text-center">
    <ion-icon name="warning-outline" class="text-4xl text-warning mb-2"></ion-icon>
    <h2 class="text-xl font-semibold mb-2">Server Not Configured</h2>
    <p class="text-muted">Please configure your server settings before accessing the library.</p>
    <ion-button routerLink="/settings" class="mt-4">
      Go to Settings
    </ion-button>
  </div>

  <!-- Library content -->
  <ng-container *ngIf="hasValidBaseUrl() && (libraryType$ | async) as libraryType">
    <ng-container *ngIf="libraryType === 'authors'">
      <!-- Loading spinner for authors -->
      <div *ngIf="isLoadingAuthors" class="flex items-center justify-center h-full">
        <ion-spinner name="crescent" color="primary" class="text-4xl"></ion-spinner>
      </div>

      <ng-container *ngIf="!isLoadingAuthors && (view$ | async) as view">
        <!-- Author Grid view -->
        <div *ngIf="view === 'grid'; else authorListView"
             class="grid grid-cols-2 gap-3 p-3 sm:grid-cols-3 md:grid-cols-4">
          <app-author-card *ngFor="let a of displayedAuthors; trackBy: trackById"
                           [author]="a">
          </app-author-card>
        </div>

        <!-- Author List view -->
        <ng-template #authorListView>
          <ion-list class="bg-transparent">
            <app-author-list-item *ngFor="let a of displayedAuthors; trackBy: trackById"
                                  [author]="a">
            </app-author-list-item>
          </ion-list>
        </ng-template>

        <!-- Search suggestion row (shown in both views) -->
        <ng-container *ngIf="(search$ | async) as term">
          <ion-list class="bg-transparent mt-4" *ngIf="term">
            <ion-item button (click)="openGlobalSearch(term)" class="bg-transparent">
              <ion-icon name="search-outline" slot="start" class="text-muted"></ion-icon>
              <ion-label class="text-text">
                Search for "{{ term }}"...
              </ion-label>
            </ion-item>
          </ion-list>
        </ng-container>
      </ng-container>
    </ng-container>

    <ng-container *ngIf="libraryType === 'books'">
      <!-- Loading spinner for books -->
      <div *ngIf="isLoadingBooks" class="flex items-center justify-center h-full">
        <ion-spinner name="crescent" color="primary" class="text-4xl"></ion-spinner>
      </div>

      <ng-container *ngIf="!isLoadingBooks && (view$ | async) as view">
        <!-- Book Grid view -->
        <div *ngIf="view === 'grid'; else bookListView"
             class="grid grid-cols-2 gap-3 p-3 sm:grid-cols-3 md:grid-cols-4">
          <app-book-card *ngFor="let b of displayedBooks; trackBy: trackById"
                         [book]="b">
          </app-book-card>
        </div>

        <!-- Book List view -->
        <ng-template #bookListView>
          <ion-list class="bg-transparent">
            <app-book-library-list-item *ngFor="let b of displayedBooks; trackBy: trackById"
                                        [book]="b">
            </app-book-library-list-item>
          </ion-list>
        </ng-template>

        <!-- Search suggestion row (shown in both views) -->
        <ng-container *ngIf="(search$ | async) as term">
          <ion-list class="bg-transparent mt-4" *ngIf="term">
            <ion-item button (click)="openGlobalSearch(term)" class="bg-transparent">
              <ion-icon name="search-outline" slot="start" class="text-muted"></ion-icon>
              <ion-label class="text-text">
                Search for "{{ term }}"...
              </ion-label>
            </ion-item>
          </ion-list>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="hasValidBaseUrl()">
    <ion-infinite-scroll (ionInfinite)="loadData($event)" threshold="200px">
      <ion-infinite-scroll-content
        loadingSpinner="bubbles"
        loadingText="Loading more...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </ng-container>

  <!-- Only show refresher control when base URL is configured -->
  <ion-refresher *ngIf="hasValidBaseUrl()" slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
</ion-content>
